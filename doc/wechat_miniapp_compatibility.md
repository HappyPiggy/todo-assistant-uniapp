# 微信小程序兼容性配置说明

## 已实施的条件编译配置

### 1. 登录页面改造
**文件**: `/pages/login/login-withpwd.vue`

#### 改动内容：
- **微信小程序环境** (`#ifdef MP-WEIXIN`)：
  - 只显示微信一键登录按钮
  - 隐藏用户名密码输入框
  - 隐藏注册链接
  - 使用微信绿色主题按钮样式
  - **新增**：登录成功后自动请求微信昵称和头像权限
    - 首次登录时弹窗询问是否使用微信资料
    - 用户同意后自动更新个人资料（昵称、头像）
    - 用户拒绝仍可正常使用，后续可在个人中心手动编辑
    - **昵称重复保护机制**：
      - 自动检测昵称是否已被占用
      - 若昵称重复，自动添加4位随机数字后缀
      - 最多重试3次，确保用户能成功设置昵称
      - 重试失败后提醒用户稍后手动设置

- **其他平台** (`#ifndef MP-WEIXIN`)：
  - 显示完整的登录选项（用户名密码、微信登录等）
  - 保留注册功能

### 2. 编辑资料页面
**文件**: `/pages/ucenter/profile/edit.vue`

#### 改动内容：
- **微信小程序环境** (`#ifdef MP-WEIXIN`)：
  - 隐藏敏感信息收集：
    - 性别选择
    - 手机号
    - 邮箱
    - 个人简介
  - 只保留必要信息：
    - 昵称
    - 头像

- **其他平台** (`#ifndef MP-WEIXIN`)：
  - 显示完整的个人信息编辑选项

### 3. 调试页面和注册页面
**文件**: `pages.json`

#### 已实施改动：
- 使用条件编译隐藏了以下页面：
  - `/pages/debug/debug` - 调试页面
  - `/pages/register/register` - 注册页面
  
这些页面在微信小程序中不会被编译和打包。

## 配置检查清单

### ✅ 已完成
- [x] 登录页面微信小程序专用界面
- [x] 编辑资料页面隐藏敏感信息收集
- [x] 微信登录按钮样式优化
- [x] pages.json 中调试页面的条件编译
- [x] pages.json 中注册页面的条件编译
- [x] 注册功能在微信小程序中禁用提示
- [x] 微信登录后自动获取用户昵称和头像（需用户授权）
- [x] 用户信息自动同步到个人资料
- [x] 昵称重复自动处理机制（添加随机后缀）

### ⚠️ 待处理
- [ ] manifest.json 权限声明优化
- [ ] 隐私政策链接更新

## 使用说明

### 1. 开发环境
在开发时，可以通过 HBuilderX 的运行配置选择不同平台：
- 运行到微信小程序：会自动应用 `MP-WEIXIN` 的条件编译
- 运行到 H5：会应用非微信小程序的完整功能

### 2. 构建发布
发布到微信小程序时，确保：
1. 使用 HBuilderX 的"发行 -> 小程序-微信"
2. 检查生成的代码中敏感信息收集已被移除
3. 确认只有微信登录入口

### 3. 隐私协议更新
需要在微信小程序后台更新隐私协议，明确说明：
- 只收集必要的用户昵称和头像
- 不收集性别、手机号、邮箱等敏感信息
- 使用微信授权登录，不存储微信密码

## 测试要点

### 微信小程序环境测试
1. 登录页面只显示微信登录
2. 首次登录后会询问是否使用微信昵称和头像
3. 编辑资料只能修改昵称和头像
4. 没有调试页面入口
5. 没有注册功能

#### 微信小程序登录流程
1. 用户点击"微信一键登录"按钮
2. 微信授权登录成功
3. 系统检测用户是否已有昵称
4. 如果没有昵称，弹窗询问是否使用微信资料
5. 用户选择"使用"后，系统请求微信用户信息权限
6. 用户在微信弹窗中授权后，自动更新昵称和头像
   - 如果昵称已被占用，自动添加随机后缀（如：张三_1234）
   - 自动重试最多3次，确保设置成功
7. 登录完成，跳转到主页

#### 昵称冲突处理机制
- **自动处理**：检测到昵称重复时，自动添加4位随机数字后缀
- **重试机制**：最多重试3次，每次使用不同的随机后缀
- **友好提示**：
  - 成功添加后缀时，提示用户最终的昵称
  - 重试失败时，提醒用户稍后在个人中心手动设置
- **不阻塞登录**：即使昵称设置失败，也不影响用户正常登录使用

### 其他平台测试
1. 登录页面显示完整选项
2. 编辑资料可以修改所有信息
3. 可以访问调试页面（开发环境）
4. 支持用户注册

## 注意事项

1. **条件编译语法**：
   - `#ifdef MP-WEIXIN` - 仅在微信小程序中编译
   - `#ifndef MP-WEIXIN` - 在非微信小程序中编译
   - `#endif` - 结束条件编译块

2. **样式条件编译**：
   在 `<style>` 标签中也可以使用条件编译，用于平台特定样式

3. **JavaScript 条件编译**：
   在 `<script>` 中的数据和方法也支持条件编译

4. **模板条件编译**：
   在 `<template>` 中使用条件编译控制界面元素显示

5. **微信用户信息获取**：
   - 使用 `getUserProfile` 接口需要用户主动触发
   - 每次请求都需要用户授权，不会自动记住
   - 获取的头像URL有时效性，建议保存到自己的云存储
   - 需要在微信小程序后台配置用户信息使用说明

## 合规性对照

根据微信小程序规范要求：

| 规范要求 | 实施状态 | 说明 |
|---------|---------|------|
| 不得强制收集个人信息 | ✅ 已实施 | 微信环境只收集昵称和头像 |
| 不得诱导用户填写信息 | ✅ 已实施 | 移除了非必要信息收集 |
| 微信登录优先 | ✅ 已实施 | 微信环境只显示微信登录 |
| 移除测试内容 | ✅ 已实施 | 调试页面已通过条件编译移除 |
| 用户信息授权 | ✅ 已实施 | 使用getUserProfile需用户主动授权 |
| 隐私政策声明 | ⚠️ 待更新 | 需要更新隐私政策链接 |