# 实施计划 - 数据导入功能

## 任务概述

将数据导入功能的设计转换为可执行的代码实现步骤。优先考虑最佳实践、渐进式开发和早期测试，确保每个阶段都没有复杂性的跳跃。每个提示都建立在前面的提示基础上，最终将所有内容连接起来。

- [ ] 1. 实现基础文件处理功能
  - 在 debug.vue 中添加文件选择按钮和隐藏的文件输入框
  - 实现 triggerImportData() 方法触发文件选择对话框
  - 实现 handleFileSelect(event) 方法处理文件选择事件
  - 实现 readFileAsText(file) 方法读取文件内容为文本
  - 添加基本的文件格式验证（.json 扩展名检查）
  - _需求: 1.1, 1.2_

- [ ] 2. 实现 JSON 数据解析和验证
  - 实现 importDataFromFile(file) 方法作为主要导入协调器
  - 添加 JSON.parse() 错误处理
  - 验证导入数据结构包含必需字段 (todobook, tasks)
  - 实现用户认证状态检查
  - 添加数据结构验证日志输出
  - _需求: 1.3, 1.4, 3.5_

- [ ] 3. 实现项目册创建功能
  - 实现 performDataImport(importData, currentUserId) 方法
  - 集成现有的 useBookData composable
  - 构建项目册数据对象，设置正确的用户所有权
  - 调用 createTodoBook() 方法创建新项目册
  - 处理项目册创建失败的中止逻辑
  - 添加项目册创建成功的日志记录
  - _需求: 3.1, 3.2, 5.1_

- [ ] 4. 实现任务批量创建和 ID 映射
  - 创建 taskIdMapping Map 存储旧 ID 到新 ID 的映射
  - 实现任务数据转换逻辑（用户 ID、项目册 ID 替换）
  - 循环创建所有任务，调用 todoItemCo.createTodoItem()
  - 构建和维护任务 ID 映射表
  - 实现任务创建失败时的继续逻辑
  - 添加任务创建进度和结果日志
  - _需求: 2.1, 3.3, 5.2_

- [ ] 5. 实现评论创建和依赖关系处理
  - 创建 commentIdMapping Map 存储评论 ID 映射
  - 按时间排序评论确保回复关系正确
  - 实现评论 reply_to 字段的 ID 映射逻辑
  - 循环创建评论，调用 todoItemCo.addTaskComment()
  - 处理评论创建失败的继续逻辑
  - 更新评论 ID 映射表
  - _需求: 2.2, 2.3_

- [ ] 6. 实现导入进度反馈和日志系统
  - 集成现有的 log(message, data) 方法
  - 实现实时进度显示（文件解析、项目册创建、任务创建、评论创建）
  - 添加实体标识信息显示（任务标题、评论内容摘要）
  - 实现导入完成状态显示
  - 实现详细错误消息记录和显示
  - _需求: 4.1, 4.2, 4.4, 4.5_

- [ ] 7. 实现错误处理和事务安全
  - 添加导入过程各阶段的 try-catch 错误捕获
  - 实现验证失败时的错误消息显示
  - 实现认证失败时的错误处理
  - 确保项目册创建失败时中止整个导入过程
  - 确保任务/评论创建失败时继续处理其他项目
  - 添加错误详情日志记录用于调试
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 8. 添加导入按钮样式和用户体验优化
  - 为导入按钮添加适当的 CSS 样式类 (.import-btn)
  - 确保按钮在界面中正确定位和显示
  - 添加按钮悬停效果样式
  - 隐藏文件输入框并确保点击导入按钮能触发文件选择
  - 测试文件选择对话框的正确显示
  - _需求: 1.1_

- [ ] 9. 集成测试和调试验证
  - 使用提供的测试数据文件测试完整导入流程
  - 验证项目册创建的正确性（标题、描述、颜色等）
  - 验证任务创建的完整性（所有字段正确映射）
  - 验证评论创建和回复关系的正确性
  - 验证用户所有权分配的正确性
  - 测试各种错误场景（无效文件、认证失败等）
  - _需求: 2.1, 2.2, 3.1, 3.2, 3.3_

- [ ] 10. 代码优化和最终集成
  - 重构重复代码到辅助方法
  - 优化错误消息的用户友好性
  - 确保所有新方法符合现有代码风格
  - 验证与现有调试功能的兼容性
  - 进行最终的功能测试和代码审查
  - _需求: 所有需求_