{
  "bsonType": "object",
  "required": ["todobook_id", "title", "creator_id", "created_at"],
  "permission": {
    "read": "get(`database.todobooks.${doc.todobook_id}`).creator_id == auth.uid",
    "create": "auth.uid != null",
    "update": "get(`database.todobooks.${doc.todobook_id}`).creator_id == auth.uid",
    "delete": "get(`database.todobooks.${doc.todobook_id}`).creator_id == auth.uid",
    "count": "get(`database.todobooks.${doc.todobook_id}`).creator_id == auth.uid"
  },
  "properties": {
    "_id": {
      "description": "ID，系统自动生成"
    },
    "todobook_id": {
      "bsonType": "string",
      "description": "所属项目册ID"
    },
    "parent_id": {
      "bsonType": "string",
      "description": "父任务ID，空表示顶级任务"
    },
    "title": {
      "bsonType": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "任务标题"
    },
    "description": {
      "bsonType": "string",
      "maxLength": 2000,
      "description": "任务描述"
    },
    "creator_id": {
      "bsonType": "string",
      "description": "创建者用户ID",
      "forceDefaultValue": {
        "$env": "uid"
      }
    },
    "assignee_id": {
      "bsonType": "string",
      "description": "指派给的用户ID"
    },
    "created_at": {
      "bsonType": "timestamp",
      "description": "创建时间",
      "forceDefaultValue": {
        "$env": "now"
      }
    },
    "updated_at": {
      "bsonType": "timestamp",
      "description": "更新时间",
      "forceDefaultValue": {
        "$env": "now"
      }
    },
    "due_date": {
      "bsonType": "timestamp",
      "description": "截止日期"
    },
    "completed_at": {
      "bsonType": "timestamp",
      "description": "完成时间"
    },
    "status": {
      "bsonType": "string",
      "enum": ["todo", "in_progress", "completed", "cancelled"],
      "default": "todo",
      "description": "状态：todo待办，in_progress进行中，completed已完成，cancelled已取消"
    },
    "priority": {
      "bsonType": "string",
      "enum": ["low", "medium", "high", "urgent"],
      "default": "medium",
      "description": "优先级"
    },
    "tags": {
      "bsonType": "array",
      "items": {
        "bsonType": "string",
        "maxLength": 20
      },
      "default": [],
      "description": "标签列表"
    },
    "sort_order": {
      "bsonType": "int",
      "default": 0,
      "description": "排序顺序"
    },
    "level": {
      "bsonType": "int",
      "minimum": 0,
      "maximum": 2,
      "default": 0,
      "description": "层级：0顶级，1二级，2三级"
    },
    "progress": {
      "bsonType": "int",
      "minimum": 0,
      "maximum": 100,
      "default": 0,
      "description": "进度百分比"
    },
    "estimated_hours": {
      "bsonType": "double",
      "minimum": 0,
      "description": "预估工时"
    },
    "actual_hours": {
      "bsonType": "double",
      "minimum": 0,
      "default": 0,
      "description": "实际工时"
    },
    "attachments": {
      "bsonType": "array",
      "items": {
        "bsonType": "object",
        "properties": {
          "file_id": {
            "bsonType": "string",
            "description": "文件ID"
          },
          "filename": {
            "bsonType": "string",
            "description": "文件名"
          },
          "file_size": {
            "bsonType": "int",
            "description": "文件大小"
          },
          "file_type": {
            "bsonType": "string",
            "description": "文件类型"
          },
          "uploaded_at": {
            "bsonType": "timestamp",
            "description": "上传时间"
          }
        }
      },
      "description": "附件列表"
    },
    "comments": {
      "bsonType": "array",
      "items": {
        "bsonType": "object",
        "properties": {
          "user_id": {
            "bsonType": "string",
            "description": "评论者用户ID"
          },
          "content": {
            "bsonType": "string",
            "maxLength": 1000,
            "description": "评论内容"
          },
          "created_at": {
            "bsonType": "timestamp",
            "description": "评论时间"
          },
          "reply_to": {
            "bsonType": "string",
            "description": "回复的评论ID"
          }
        }
      },
      "description": "评论列表"
    },
    "subtask_count": {
      "bsonType": "int",
      "minimum": 0,
      "default": 0,
      "description": "子任务数量"
    },
    "completed_subtask_count": {
      "bsonType": "int",
      "minimum": 0,
      "default": 0,
      "description": "已完成子任务数量"
    },
    "is_recurring": {
      "bsonType": "bool",
      "default": false,
      "description": "是否循环任务"
    },
    "recurrence_rule": {
      "bsonType": "object",
      "properties": {
        "type": {
          "bsonType": "string",
          "enum": ["daily", "weekly", "monthly", "yearly"],
          "description": "循环类型"
        },
        "interval": {
          "bsonType": "int",
          "minimum": 1,
          "default": 1,
          "description": "循环间隔"
        },
        "end_date": {
          "bsonType": "timestamp",
          "description": "循环结束日期"
        }
      },
      "description": "循环规则"
    },
    "last_activity_at": {
      "bsonType": "timestamp",
      "description": "最后活动时间",
      "forceDefaultValue": {
        "$env": "now"
      }
    }
  }
}