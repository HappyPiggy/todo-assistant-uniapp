<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>数据库调试测试</title>
    <script src="https://unpkg.com/@dcloudio/uni-cloud/dist/index.js"></script>
</head>
<body>
    <h1>数据库调试测试</h1>
    <button onclick="testDatabase()">测试数据库</button>
    <button onclick="testPermissions()">测试权限</button>
    <div id="results"></div>

    <script>
        // 初始化 uniCloud
        const uniCloud = require('@dcloudio/uni-cloud')
        
        async function testDatabase() {
            const results = document.getElementById('results')
            results.innerHTML = '<p>正在检查数据库...</p>'
            
            try {
                // 调用调试云函数
                const result = await uniCloud.callFunction({
                    name: 'debug-db'
                })
                
                results.innerHTML = `
                    <h2>数据库检查结果:</h2>
                    <pre>${JSON.stringify(result.result, null, 2)}</pre>
                `
            } catch (error) {
                results.innerHTML = `
                    <h2>错误:</h2>
                    <p style="color: red;">${error.message}</p>
                    <pre>${error.stack}</pre>
                `
            }
        }
        
        async function testPermissions() {
            const results = document.getElementById('results')
            results.innerHTML = '<p>正在测试权限...</p>'
            
            try {
                // 直接查询数据库测试权限
                const db = uniCloud.database()
                
                // 测试 todobooks 查询
                const todoBooksResult = await db.collection('todobooks').get()
                
                // 测试 todobook_members 查询
                const membersResult = await db.collection('todobook_members').get()
                
                results.innerHTML = `
                    <h2>权限测试结果:</h2>
                    <p>todobooks 查询成功: ${todoBooksResult.data.length} 条记录</p>
                    <p>todobook_members 查询成功: ${membersResult.data.length} 条记录</p>
                    <h3>详细数据:</h3>
                    <pre>${JSON.stringify({
                        todobooks: todoBooksResult.data.slice(0, 2),
                        members: membersResult.data.slice(0, 2)
                    }, null, 2)}</pre>
                `
            } catch (error) {
                results.innerHTML = `
                    <h2>权限测试失败:</h2>
                    <p style="color: red;">${error.message}</p>
                    <p>错误代码: ${error.code}</p>
                    <pre>${error.stack}</pre>
                `
            }
        }
    </script>
</body>
</html>